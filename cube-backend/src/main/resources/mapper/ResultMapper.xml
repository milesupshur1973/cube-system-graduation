<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.whd.cube.mapper.ResultMapper">

    <select id="selectGlobalRankings" resultType="com.whd.cube.vo.RankingVO">
        SELECT
        u.name AS userName,
        u.display_id AS userDisplayId,
        u.province AS userProvince,

        <if test="type == 'best'"> r.best AS bestScore, </if>
        <if test="type == 'average'"> r.average AS bestScore, </if>

        /* ★★★ 核心修改：加上 MAX() 函数，解决 SQL 报错 ★★★ */
        MAX(c.name) AS competitionName,
        MAX(c.slug) AS competitionSlug,
        MAX(c.start_date) AS competitionDate

        FROM
        result r
        JOIN
        sys_user u ON r.user_id = u.id
        JOIN
        competition c ON r.competition_id = c.id
        JOIN
        (
        SELECT
        user_id,
        <if test="type == 'best'"> MIN(best) </if>
        <if test="type == 'average'"> MIN(average) </if>
        AS min_score
        FROM result
        WHERE event_id = #{eventId}
        AND <if test="type == 'best'"> best </if><if test="type == 'average'"> average </if> > 0
        GROUP BY user_id
        ) best_r
        ON r.user_id = best_r.user_id
        AND <if test="type == 'best'"> r.best </if><if test="type == 'average'"> r.average </if> = best_r.min_score
        WHERE
        r.event_id = #{eventId}
        <if test="region != null and region != ''">
            AND u.province = #{region}
        </if>
        GROUP BY u.id
        ORDER BY
        bestScore ASC
    </select>

    <select id="selectPersonalBests" resultType="com.whd.cube.vo.PersonalBestVO">
        SELECT
            e.name AS eventName,

            /* 1. 查出单次最好成绩 */
            MIN(CASE WHEN r.best > 0 THEN r.best END) AS best,

            /* 2. 查出平均最好成绩 */
            MIN(CASE WHEN r.average > 0 THEN r.average END) AS average,

            /* 3. ★★★ 查出单次最好成绩对应的比赛名称 ★★★ */
            (SELECT c.name FROM result r2
                                    LEFT JOIN competition c ON r2.competition_id = c.id
             WHERE r2.user_display_id = #{displayId}
               AND r2.event_id = r.event_id
               AND r2.best > 0
               AND c.status = 3  ORDER BY r2.best ASC, r2.create_time DESC LIMIT 1
            ) AS bestCompName,

        (SELECT c.name FROM result r3
            LEFT JOIN competition c ON r3.competition_id = c.id
            WHERE r3.user_display_id = #{displayId}
            AND r3.event_id = r.event_id
            AND r3.average > 0
            AND c.status = 3  ORDER BY r3.average ASC, r3.create_time DESC LIMIT 1
            ) AS averageCompName

        FROM
            result r
            LEFT JOIN event e ON r.event_id = e.id
            LEFT JOIN competition c_main ON r.competition_id = c_main.id WHERE
            r.user_display_id = #{displayId}
                                                                           AND c_main.status = 3 GROUP BY
            r.event_id, e.name
        ORDER BY
            r.event_id ASC
    </select>

    <select id="selectCompetitionDetails" resultType="com.whd.cube.vo.CompetitionResultVO">
        SELECT
        r.*,
        u.name AS userName,
        u.province AS userProvince,
        u.gender AS userGender
        FROM result r
        LEFT JOIN sys_user u ON r.user_id = u.id
        WHERE r.competition_id = #{competitionId}
        <if test="roundId != null">
            AND r.round_id = #{roundId}
        </if>
        <if test="eventId != null and eventId != ''">
            AND r.event_id = #{eventId}
        </if>
        ORDER BY
        /* WCA 标准排序：先看平均，再看单次，DNF排最后 */
        CASE WHEN r.average > 0 THEN 0 ELSE 1 END ASC,
        r.average ASC,
        CASE WHEN r.best > 0 THEN 0 ELSE 1 END ASC,
        r.best ASC
    </select>

    <select id="selectHistoryResults" resultType="com.whd.cube.vo.HistoryResultVO">
        SELECT
            r.value1, r.value2, r.value3, r.value4, r.value5,
            r.best, r.average, r.round_type,
            e.name AS eventName,
            c.name AS competitionName,
            c.slug AS competitionSlug,
            c.start_date AS competitionDate
        FROM
            result r
                LEFT JOIN competition c ON r.competition_id = c.id
                LEFT JOIN event e ON r.event_id = e.id
        WHERE
            r.user_display_id = #{displayId}
          AND c.status = 3  ORDER BY
                                c.start_date DESC,
                                e.id ASC
    </select>

    <insert id="batchInitRound1">
        INSERT INTO result (competition_id, event_id, round_id, user_id, user_display_id, create_time)
        SELECT
            r.competition_id,
            ri.event_id,
            #{roundId},
            r.user_id,
            u.display_id,
            NOW()
        FROM registration r
                 JOIN registration_item ri ON r.id = ri.registration_id
                 JOIN sys_user u ON r.user_id = u.id
        WHERE r.competition_id = #{competitionId}
          AND r.status = 1
          AND ri.event_id = #{eventId}
          AND NOT EXISTS (
            SELECT 1 FROM result res
            WHERE res.competition_id = r.competition_id
              AND res.event_id = ri.event_id
              AND res.round_id = #{roundId}
              AND res.user_id = r.user_id
        )
    </insert>

    <insert id="batchPromote">
        INSERT INTO result (competition_id, event_id, round_id, user_id, user_display_id, create_time)
        SELECT
            temp.competition_id,
            temp.event_id,
            #{nextRoundId},
            temp.user_id,
            temp.user_display_id,
            NOW()  FROM (
                            SELECT * FROM result
                            WHERE competition_id = #{competitionId}
                              AND event_id = #{eventId}
                              AND round_id = #{currentRoundId}
                              AND (best > 0 OR average > 0)
                            ORDER BY
                                CASE WHEN average > 0 THEN 0 ELSE 1 END ASC,
                                average ASC,
                                CASE WHEN best > 0 THEN 0 ELSE 1 END ASC,
                                best ASC
                                LIMIT #{limit}
                        ) AS temp
        WHERE NOT EXISTS (
            SELECT 1 FROM result existing
            WHERE existing.competition_id = temp.competition_id
              AND existing.event_id = temp.event_id
              AND existing.round_id = #{nextRoundId}
              AND existing.user_id = temp.user_id
        )
    </insert>

</mapper>
